@{
    ViewData["Title"] = "Plans";
}

<h4>
    Plans
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createReportModal" aria-label="Left Align"><span class="fas fa-plus-square"></span>&nbsp;&nbsp;Create New</button>
    <span id="loading"></span>
</h4>
<div id="alert-template" style="display:none;">
    <div class="alert alert-danger"></div>
    <div class="alert alert-warning"></div>
    <div class="alert alert-success"></div>
</div>
<div id="icon-template" style="display:none;">
    <i class="loading-icon fas fa-cog ld ld-spin"></i>
    <i class="sort-icon fas fa-filter"></i>
</div>
<hr />
<div id="tableTemplate" style="display:none;">
    <table class="table table-sm table-bordered table-striped table-hover">
        <thead>
            <tr>
                <th class="sortOption">
                    <a>Id</a>
                </th>
                <th class="sortOption">
                    <a>Name</a>
                </th>
                <th class="sortOption">
                    <a>State</a>
                </th>
                <th class="sortOption">
                    <a>WindwardId</a>
                </th>
                <th class="sortOption">
                    <a>HasActiveReports</a>
                </th>
                <th class="sortOption">
                    <a>HasTermedReports</a>
                </th>
                <th>Options</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
<div id="tableContentTemplate" style="display:none;">
    <table>
        <tbody>
            <tr>
                <td class="planId"></td>
                <td class="planName"></td>
                <td class="stateName"></td>
                <td class="windwardId"></td>
                <td class="hasActiveReports"></td>
                <td class="hasTermedReports"></td>
                <td>
                    <a class="manage"><i class="fas fa-edit"></i></a>
                    <a class="details"><i class="fas fa-book"></i></a>
                    <a class="reports"><i class="fas fa-arrow-right"></i></a>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<table  class="table table-sm table-bordered" id="navigation" style="padding-bottom: 0rem;">
    <thead>
        <tr>
            <th colspan="1">
                Plans
                <span class="float-right">
                    <span class="input-group input-group-sm">
                       <i class="prev btn btn-outline-primary input-group-addon fas fa-chevron-left "></i>
                        <span class="input-group-addon">
                            <span class="indicator" style="padding-left:1.5rem; padding-right:1.5rem;">
                                <span class="index" style="padding-right:1.5rem;"> </span>
                                /
                                <span class="total" style="padding-left:1.5rem;padding-right:1.5rem;"> </span>
                            </span>
                        </span>
                        <i class="next fas fa-chevron-right btn btn-outline-primary input-group-addon"></i>
                    </span>
                </span>
            </th>
        </tr>
    </thead>
    <tbody>
        <tr></tr>
    </tbody>
</table>
<div id="status">

</div>
<div class="plansTable">
    <table class="table table-sm table-bordered table-striped table-hover">
        <thead>
            <tr>
                <th>
                    <a class="sortOption">Id</a>
                </th>
                <th>
                    <a class="sortOption">Name</a>
                </th>
                <th>
                    <a class="sortOption">State</a>
                </th>
                <th>
                    <a class="sortOption">WindwardId</a>
                </th>
                <th>
                    <a class="sortOption">HasActiveReports</a>
                </th>
                <th>
                    <a class="sortOption">HasTermedReports</a>
                </th>
                <th>Options</th>
            </tr>
            <tr>
                <th>
                    <input id="searchId" class="form-control" placeholder="Id" type="text" style="max-width:5.0rem;max-height:2.5rem;">
                </th>
                <th>
                    <input id="searchName" class="form-control" placeholder="Name" type="text" style="max-width:100%;max-height:2.5rem;">
                </th>
                <th>
                    <input id="searchState" class="form-control" placeholder="State" type="text" style="max-width:5.0rem;max-height:2.5rem;">
                </th>
                <th>
                    <input id="searchWindwardId" class="form-control" placeholder="WWID" type="text" style="max-width:7.5rem;max-height:2.5rem;">
                </th>
                <th>
                    @*<div class="form-group form-inline">
                        <input id="searchActiveTrue" class="custom-checkbox form-control" type="checkbox" value="checkActiveReportsTrue" checked><label class="form-check-label">&nbsp;True&nbsp;</label>
                        <input id="searchActiveFalse" class="custom-checkbox form-control" type="checkbox" value="checkActiveReportsFalse" checked><label class="form-check-label">&nbsp;False&nbsp;</label>
                    </div>*@
                </th>
                <th>
                    @*<div class="form-group form-inline">
                        <input id="searchTermedTrue" class="custom-checkbox form-control" type="checkbox" value="checkActiveReportsTrue" checked><label class="form-check-label">&nbsp;True&nbsp;</label>
                        <input id="searchTermedFalse" class="custom-checkbox form-control" type="checkbox" value="checkActiveReportsFalse" checked><label class="form-check-label">&nbsp;False&nbsp;</label>
                    </div>*@
                </th>
                <th>
                    <div class="btn-group btn-group-sm" role="group" aria-label="search button group">
                        <button id="search" type="button" class="btn btn-outline-primary"><i class="fas fa-search"></i></button>
                        <button id="clear" type="button" class="btn btn-outline-primary"><i class="fas fa-times"></i></button>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
@section scripts{ 
    <script>
        $(document).ready(function () {
            let _page = 1;
            let _size = 20;
            let _total;
            let _id;
            let _name;
            let _state;
            let _windwardId;
            let _sort;
            function getWholeSize(id, name, state, windwardId) {
                let request = $.ajax({
                    type: 'GET',
                    url: 'api/Plans/',
                    data: { id: id, name: name, state: state, windwardId: windwardId, sort: null, from: null, take: null },
                    dataType: 'json',
                    success: function (data) {
                        if ($(data).length > 0) {
                            let current = parseInt($(data).length % _size === 0 ? ($(data).length / _size) : ($(data).length / _size) + 1);
                            $('.total').text(current);
                        } else {
                            $('#loadingIcon').find('i').fadeOut(200, function () {
                                $('#status').html($('#alert-template').find('.alert-warning').clone(false));
                                $('#status').find('.alert').text('No Plans Found');
                            });
                        };

                    },
                    error: function (a, b, c) {
                        $('#loadingIcon').find('i').fadeOut(200, function () {
                            $('#status').html($('#alert-template').find('.alert-danger').clone(false));
                            $('#status').find('.alert').text(c);
                        });
                    }
                });

            }
            $('#search').click(function () {
                search($('#searchId').val(), $('#searchName').val(), $('#searchState').val(), $('#searchWindwardId').val());            
            });
            $('#clear').click(function () {
                $('input').val('');
                $('.custom-checkbox').prop('checked', true);
                search();      
            });
            function search(id, name, state, windwardId) {
                _page = 1;
                $('.index').text(_page);
                $('#loading').html($('#icon-template').find('.loading-icon').clone(false));
                getPlans(id, name, state, windwardId, _sort, (_page - 1) * 20, 20);
                getWholeSize(id, name, state, windwardId);
            }
            

            function getPlans(id, name, state, windwardId, sort, start, take) {
                _id = id;
                _name = name;
                _sort = sort;
                _state = state;
                _windwardId = windwardId;
                $('#status').html('');
                let request = $.ajax({
                    type: 'GET',
                    url: 'api/Plans/',
                    data: { id: _id, name: _name, state: _state, windwardId: _windwardId, sort: _sort, from: start, take: take},
                    dataType: 'json',
                    waitTime: 5000,
                    success: function (data) {
                        history.replaceState(null, null, '/Plans?id='+_id+'&name='+_name+'&state='+_state+'&windwardId='+_windwardId+'&sort='+_sort+'&from='+start+'&take='+take);
                        $('#status').html('');
                        if (data && $(data).length > 0) {
                            let items = [];
                            $(data).each(function (i, e) {
                                items.push(buildRow(e));
                            });
                            $('.plansTable').find('tbody').html(items);
                            $('#loading').find('i').fadeOut(200);
                        }
                        if(data.length === 0){
                            $('#loading').find('i').fadeOut(200);
                            $('.plansTable').find('tbody').children().hide();
                            $('#status').html($('#alert-template').find('.alert-warning').clone(false));
                            $('#status').find('.alert').text('No Plans Found');
                        };
                    },
                    error: function (a, b, c) {
                        $('#loadingIcon').find('i').fadeOut(200, function () {
                            $('#status').html($('#alert-template').find('.alert-danger').clone(false));
                            $('#status').find('.alert').text(c);
                        });
                    }
                });
            }
            function buildRow(plan) {
                let row = $('#tableContentTemplate').find('tr').clone(true);
                $(row).find('.planId').text(plan.id);
                $(row).find('.planName').text(plan.name);
                $(row).find('.stateName').text(plan.state);
                $(row).find('.hasActiveReports').text(plan.hasActiveReports);
                $(row).find('.hasTermedReports').text(plan.hasTermedReports);
                $(row).find('.windwardId').text(plan.windwardId);
                $(row).find('.manage').attr('href', 'Plans/' + plan.id);
                $(row).find('.details').attr('href', 'Plans/Details/' + plan.id);
                $(row).find('.reports').attr('href', ('Reports?State=' + plan.state + '&Plan=' + plan.name).replace(/ /g, '+'));
                return row;
            }
            function init() {
                _page = 1;
                $('.index').text(_page);
                $('#loading').html($('#icon-template').find('.loading-icon').clone(false));
                search($('#searchId').val(), $('#searchName').val(), $('#searchState').val(), $('#searchWindwardId').val());            
            }
            $('.sortOption').click(function () {
                let _sort = $(this).text();
                $('.sortOption').find('i').hide();
                $(this).append($('#icon-template').find('.sort-icon').clone(false))
                $('#loading').html($('#icon-template').find('.loading-icon').clone(false));
                getPlans(_id, _name, _state, _windwardId, _sort, (_page - 1) * 20, 20);
            });
            $('.next').click(function () {
                if (_page !== parseInt($('.total').text())) {
                    _page = _page + 1;
                    $('.index').text(_page);
                    $('#loading').html($('#icon-template').find('.loading-icon').clone(false));
                    getPlans(_id, _name, _state, _windwardId, _sort, (_page - 1) * 20, 20);
                }
            })
            $('.prev').click(function () {
                if (_page > 1) {
                    _page = _page - 1;
                    $('.index').text(_page);
                    $('#loading').html($('#icon-template').find('.loading-icon').clone(false));
                    getPlans(_id, _name, _state, _windwardId, _sort, (_page - 1) * 20, 20);
                }
            })
            init();
        });
    </script>
}